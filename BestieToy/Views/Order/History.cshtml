@model IEnumerable<BestieToy.Models.Order>
@using Microsoft.AspNetCore.Html
@{
    ViewData["Title"] = "Lịch sử đơn hàng";
    ViewData["AdditionalCss"] = "orders";
}

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="bg-light py-3">
    <div class="container">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Trang chủ</a></li>
            <li class="breadcrumb-item"><a asp-controller="Profile" asp-action="Index">Tài khoản</a></li>
            <li class="breadcrumb-item active" aria-current="page">Lịch sử đơn hàng</li>
        </ol>
    </div>
</nav>

<!-- Orders History Section -->
<section class="py-5">
    <div class="container">
        <div class="row">
            <!-- Sidebar Navigation -->
            <div class="col-lg-3 mb-4">
                <div class="card shadow-sm">
                    <div class="card-body p-3">
                        <div class="d-flex flex-column align-items-center text-center mb-4">
                            <div class="profile-avatar mb-3">
                                <i class="fas fa-user-circle fa-4x text-primary"></i>
                            </div>
                            <h5 class="mb-1">@User.Identity?.Name</h5>
                            <p class="text-muted small mb-0">Lịch sử đơn hàng</p>
                        </div>

                        <nav class="nav flex-column">
                            <a class="nav-link" asp-controller="Profile" asp-action="Index">
                                <i class="fas fa-user me-2"></i>Thông tin cá nhân
                            </a>
                            <a class="nav-link" asp-controller="Profile" asp-action="Edit">
                                <i class="fas fa-edit me-2"></i>Cập nhật thông tin
                            </a>
                            <a class="nav-link" asp-controller="Profile" asp-action="ChangePassword">
                                <i class="fas fa-key me-2"></i>Đổi mật khẩu
                            </a>
                            <a class="nav-link active" asp-controller="Order" asp-action="History">
                                <i class="fas fa-history me-2"></i>Lịch sử đơn hàng
                            </a>
                            <hr class="my-2">
                            <form asp-controller="Auth" asp-action="Logout" method="post">
                                <button type="submit" class="nav-link text-danger border-0 bg-transparent w-100 text-start">
                                    <i class="fas fa-sign-out-alt me-2"></i>Đăng xuất
                                </button>
                            </form>
                        </nav>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-9">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="mb-0"><i class="fas fa-history me-2"></i>Lịch sử đơn hàng</h4>
                            <span class="badge bg-light text-primary">@Model?.Count() đơn hàng</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Filter Controls -->
                        <div class="row mb-4">
                            <div class="col-md-6 mb-3">
                                <label for="statusFilter" class="form-label">Lọc theo trạng thái</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="all">Tất cả trạng thái</option>
                                    <option value="pending">Đang chờ xử lý</option>
                                    <option value="confirmed">Đã xác nhận</option>
                                    <option value="shipping">Đang giao hàng</option>
                                    <option value="delivered">Đã giao hàng</option>
                                    <option value="cancelled">Đã hủy</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="dateFilter" class="form-label">Lọc theo thời gian</label>
                                <select class="form-select" id="dateFilter">
                                    <option value="all">Tất cả thời gian</option>
                                    <option value="7days">7 ngày qua</option>
                                    <option value="30days">30 ngày qua</option>
                                    <option value="90days">90 ngày qua</option>
                                    <option value="2024">Năm 2024</option>
                                </select>
                            </div>
                        </div>

                        <!-- Orders List -->
                        @if (Model != null && Model.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Mã đơn hàng</th>
                                            <th>Ngày đặt</th>
                                            <th>Sản phẩm</th>
                                            <th>Tổng tiền</th>
                                            <th>Trạng thái</th>
                                            <th>Thao tác</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var order in Model)
                                        {
                                            <tr class="order-row" data-status="@order.Status?.ToLower()">
                                                <td>
                                                    <strong>@order.OrderId</strong>
                                                </td>
                                                <td>@order.OrderDate.ToString("dd/MM/yyyy HH:mm")</td>
                                                <td>
                                                    <div class="product-count">
                                                        @(order.OrderDetails?.Count ?? 0) sản phẩm
                                                    </div>
                                                </td>
                                                <td>
                                                    <strong class="text-primary">@order.TotalAmount.ToString("N0") đ</strong>
                                                </td>
                                                <td>
                                                    @GetStatusBadge(order.Status ?? "")
                                                </td>
                                                <td>
                                                    <a asp-controller="Order" asp-action="Detail" asp-route-id="@order.OrderId"
                                                       class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-eye me-1"></i>Xem
                                                    </a>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>

                            <!-- Pagination -->
                            <nav aria-label="Page navigation">
                                <ul class="pagination justify-content-center">
                                    <li class="page-item disabled">
                                        <a class="page-link" href="#" tabindex="-1">Trước</a>
                                    </li>
                                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                                    <li class="page-item"><a class="page-link" href="#">3</a></li>
                                    <li class="page-item">
                                        <a class="page-link" href="#">Tiếp</a>
                                    </li>
                                </ul>
                            </nav>
                        }
                        else
                        {
                            <!-- Empty State -->
                            <div class="text-center py-5">
                                <div class="empty-state-icon mb-4">
                                    <i class="fas fa-shopping-bag fa-4x text-muted"></i>
                                </div>
                                <h4 class="text-muted mb-3">Chưa có đơn hàng nào</h4>
                                <p class="text-muted mb-4">Bạn chưa mua sản phẩm nào từ BestieToy</p>
                                <a asp-controller="Product" asp-action="Index" class="btn btn-primary btn-lg">
                                    <i class="fas fa-shopping-cart me-2"></i>Mua sắm ngay
                                </a>
                            </div>
                        }
                    </div>
                </div>

                <!-- Order Statistics -->
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="stat-card text-center p-3 border rounded bg-light">
                            <div class="stat-icon mb-2">
                                <i class="fas fa-clock fa-2x text-warning"></i>
                            </div>
                            <h4 class="mb-1">@Model?.Count(o => o.Status == "Pending")</h4>
                            <p class="mb-0 small text-muted">Đang chờ xử lý</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card text-center p-3 border rounded bg-light">
                            <div class="stat-icon mb-2">
                                <i class="fas fa-check-circle fa-2x text-primary"></i>
                            </div>
                            <h4 class="mb-1">@Model?.Count(o => o.Status == "Confirmed")</h4>
                            <p class="mb-0 small text-muted">Đã xác nhận</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card text-center p-3 border rounded bg-light">
                            <div class="stat-icon mb-2">
                                <i class="fas fa-shipping-fast fa-2x text-info"></i>
                            </div>
                            <h4 class="mb-1">@Model?.Count(o => o.Status == "Shipping")</h4>
                            <p class="mb-0 small text-muted">Đang giao hàng</p>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card text-center p-3 border rounded bg-light">
                            <div class="stat-icon mb-2">
                                <i class="fas fa-box-open fa-2x text-success"></i>
                            </div>
                            <h4 class="mb-1">@Model?.Count(o => o.Status == "Delivered")</h4>
                            <p class="mb-0 small text-muted">Đã giao hàng</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@functions {
    public IHtmlContent GetStatusBadge(string status)
    {
        if (string.IsNullOrEmpty(status))
        {
            return new HtmlString("<div class='status-badge unknown'>Không xác định</div>");
        }

        var (badgeClass, statusText) = status.ToLower() switch
        {
            "pending" => ("warning", "Đang chờ"),
            "confirmed" => ("primary", "Đã xác nhận"),
            "shipping" => ("info", "Đang giao"),
            "delivered" => ("success", "Đã giao"),
            "cancelled" => ("danger", "Đã hủy"),
            _ => ("secondary", status)
        };

        return new HtmlString($"<div class='status-badge {badgeClass}'>{statusText}</div>");
    }
}

@section Scripts {
    <script>
        $(document).ready(function() {
            // Filter orders by status
            $('#statusFilter').change(function() {
                var selectedStatus = $(this).val();
                $('.order-row').show();

                if (selectedStatus !== 'all') {
                    $('.order-row').each(function() {
                        var rowStatus = $(this).data('status');
                        if (rowStatus !== selectedStatus) {
                            $(this).hide();
                        }
                    });
                }
            });

            // Filter orders by date
            $('#dateFilter').change(function() {
                var filterValue = $(this).val();
                // In real app, this would be an AJAX call to server
                console.log('Filter by date:', filterValue);
            });

            // Export orders (placeholder)
            $('#exportOrders').click(function() {
                alert('Tính năng xuất đơn hàng đang được phát triển');
            });
        });
    </script>
}