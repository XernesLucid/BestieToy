@model BestieToy.ViewModels.ProductListViewModel

@{
    ViewData["Title"] = Model.PageTitle;
}

<!-- Page Header -->
<div class="page-header py-4 mb-4 bg-light">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">@Model.PageTitle</h1>
                <p class="text-muted mb-0">
                    @if (Model.TotalProducts > 0)
                    {
                        <span>Hiển thị @Model.Products.Count() trên tổng số @Model.TotalProducts sản phẩm</span>
                    }
                    else
                    {
                        <span>Không tìm thấy sản phẩm nào</span>
                    }
                </p>
            </div>
            <div class="col-md-4 text-md-end">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb justify-content-md-end mb-0">
                        <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Trang chủ</a></li>
                        <li class="breadcrumb-item active">@Model.PageTitle</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="row">
        <!-- Sidebar Filters -->
        <div class="col-lg-3 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">Lọc sản phẩm</h5>

                    <!-- Search Box -->
                    <form method="get" class="mb-4">
                        <div class="input-group">
                            <input type="text" class="form-control" name="search"
                                   value="@Model.SearchKeyword" placeholder="Tìm sản phẩm...">
                            <button class="btn btn-primary" type="submit">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </form>

                    <!-- Categories -->
                    @if (Model.Categories.Any())
                    {
                        <div class="filter-section mb-4">
                            <h6 class="mb-3">Danh mục</h6>
                            <div class="list-group list-group-flush">
                                <a asp-controller="Product" asp-action="Index"
                                   class="list-group-item list-group-item-action @(string.IsNullOrEmpty(Model.CategoryId) ? "active" : "")">
                                    Tất cả danh mục
                                </a>
                                @foreach (var category in Model.Categories)
                                {
                                    <a asp-controller="Product" asp-action="Index"
                                       asp-route-categoryId="@category.CategoryId"
                                       class="list-group-item list-group-item-action @(Model.CategoryId == category.CategoryId ? "active" : "")">
                                        @category.CategoryName
                                        <span class="badge bg-light text-dark float-end">@category.PetType</span>
                                    </a>
                                }
                            </div>
                        </div>
                    }

                    <!-- Pet Type -->
                    <div class="filter-section mb-4">
                        <h6 class="mb-3">Loại thú cưng</h6>
                        <div class="btn-group w-100" role="group">
                            <a asp-controller="Product" asp-action="Index"
                               class="btn btn-outline-primary @(string.IsNullOrEmpty(Model.PetType) ? "active" : "")">
                                Tất cả
                            </a>
                            <a asp-controller="Product" asp-action="Index" asp-route-petType="Dog"
                               class="btn btn-outline-primary @(Model.PetType == "Dog" ? "active" : "")">
                                <i class="fas fa-dog me-1"></i> Chó
                            </a>
                            <a asp-controller="Product" asp-action="Index" asp-route-petType="Cat"
                               class="btn btn-outline-primary @(Model.PetType == "Cat" ? "active" : "")">
                                <i class="fas fa-cat me-1"></i> Mèo
                            </a>
                        </div>
                    </div>

                    <!-- Price Range -->
                    <div class="filter-section mb-4">
                        <h6 class="mb-3">Khoảng giá</h6>
                        <form method="get">
                            @if (!string.IsNullOrEmpty(Model.CategoryId))
                            {
                                <input type="hidden" name="categoryId" value="@Model.CategoryId" />
                            }
                            @if (!string.IsNullOrEmpty(Model.PetType))
                            {
                                <input type="hidden" name="petType" value="@Model.PetType" />
                            }
                            @if (!string.IsNullOrEmpty(Model.SearchKeyword))
                            {
                                <input type="hidden" name="search" value="@Model.SearchKeyword" />
                            }

                            <div class="row g-2 mb-3">
                                <div class="col">
                                    <input type="number" class="form-control" name="minPrice"
                                           value="@Model.MinPrice" placeholder="Từ" min="0">
                                </div>
                                <div class="col">
                                    <input type="number" class="form-control" name="maxPrice"
                                           value="@Model.MaxPrice" placeholder="Đến" min="0">
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                Áp dụng
                            </button>
                            @if (Model.MinPrice.HasValue || Model.MaxPrice.HasValue)
                            {
                                <a asp-controller="Product" asp-action="Index"
                                   class="btn btn-link w-100 text-decoration-none">
                                    Xóa lọc giá
                                </a>
                            }
                        </form>
                    </div>

                    <!-- Clear All Filters -->
                    @if (!string.IsNullOrEmpty(Model.CategoryId) || !string.IsNullOrEmpty(Model.PetType) ||
                                        !string.IsNullOrEmpty(Model.SearchKeyword) || Model.MinPrice.HasValue || Model.MaxPrice.HasValue)
                    {
                        <div class="text-center">
                            <a asp-controller="Product" asp-action="Index"
                               class="btn btn-outline-secondary w-100">
                                <i class="fas fa-times me-2"></i>Xóa tất cả bộ lọc
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-lg-9">
            <!-- Sorting and View Options -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body py-3">
                    <div class="row align-items-center">
                        <div class="col-md-6 mb-2 mb-md-0">
                            <span class="text-muted">
                                Sắp xếp theo:
                            </span>
                            <div class="btn-group ms-2" role="group">
                                <a asp-controller="Product" asp-action="Index"
                                   asp-route-sortBy="newest"
                                   class="btn btn-outline-secondary btn-sm @(Model.SortBy == "newest" ? "active" : "")">
                                    Mới nhất
                                </a>
                                <a asp-controller="Product" asp-action="Index"
                                   asp-route-sortBy="price_asc"
                                   class="btn btn-outline-secondary btn-sm @(Model.SortBy == "price_asc" ? "active" : "")">
                                    Giá thấp
                                </a>
                                <a asp-controller="Product" asp-action="Index"
                                   asp-route-sortBy="price_desc"
                                   class="btn btn-outline-secondary btn-sm @(Model.SortBy == "price_desc" ? "active" : "")">
                                    Giá cao
                                </a>
                                <a asp-controller="Product" asp-action="Index"
                                   asp-route-sortBy="name"
                                   class="btn btn-outline-secondary btn-sm @(Model.SortBy == "name" ? "active" : "")">
                                    Tên A-Z
                                </a>
                            </div>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <span class="text-muted me-2">Hiển thị:</span>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-secondary btn-sm active">
                                    <i class="fas fa-th"></i>
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm">
                                    <i class="fas fa-list"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Products Grid -->
            @if (Model.Products.Any())
            {
                <div class="product-grid">
                    @foreach (var product in Model.Products)
                    {
                        <partial name="_ProductCard" model="product" />
                    }
                </div>

                <!-- Pagination -->
                @if (Model.TotalPages > 1)
                {
                    <nav aria-label="Page navigation" class="mt-5">
                        <ul class="pagination justify-content-center">
                            <li class="page-item @(Model.CurrentPage == 1 ? "disabled" : "")">
                                <a class="page-link"
                                   asp-controller="Product"
                                   asp-action="Index"
                                   asp-route-page="@(Model.CurrentPage - 1)"
                                   asp-route-categoryId="@Model.CategoryId"
                                   asp-route-petType="@Model.PetType"
                                   asp-route-search="@Model.SearchKeyword"
                                   asp-route-sortBy="@Model.SortBy"
                                   asp-route-minPrice="@Model.MinPrice"
                                   asp-route-maxPrice="@Model.MaxPrice">
                                    <i class="fas fa-chevron-left"></i>
                                </a>
                            </li>

                            @for (int i = 1; i <= Model.TotalPages; i++)
                            {
                                if (i == 1 || i == Model.TotalPages || (i >= Model.CurrentPage - 2 && i <= Model.CurrentPage + 2))
                                {
                                    <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                        <a class="page-link"
                                           asp-controller="Product"
                                           asp-action="Index"
                                           asp-route-page="@i"
                                           asp-route-categoryId="@Model.CategoryId"
                                           asp-route-petType="@Model.PetType"
                                           asp-route-search="@Model.SearchKeyword"
                                           asp-route-sortBy="@Model.SortBy"
                                           asp-route-minPrice="@Model.MinPrice"
                                           asp-route-maxPrice="@Model.MaxPrice">
                                            @i
                                        </a>
                                    </li>
                                }
                                else if (i == Model.CurrentPage - 3 || i == Model.CurrentPage + 3)
                                {
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                }
                            }

                            <li class="page-item @(Model.CurrentPage == Model.TotalPages ? "disabled" : "")">
                                <a class="page-link"
                                   asp-controller="Product"
                                   asp-action="Index"
                                   asp-route-page="@(Model.CurrentPage + 1)"
                                   asp-route-categoryId="@Model.CategoryId"
                                   asp-route-petType="@Model.PetType"
                                   asp-route-search="@Model.SearchKeyword"
                                   asp-route-sortBy="@Model.SortBy"
                                   asp-route-minPrice="@Model.MinPrice"
                                   asp-route-maxPrice="@Model.MaxPrice">
                                    <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>
                }
            }
            else
            {
                <!-- No Products Found -->
                <div class="text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-search fa-4x text-muted"></i>
                    </div>
                    <h3 class="mb-3">Không tìm thấy sản phẩm</h3>
                    <p class="text-muted mb-4">
                        @if (!string.IsNullOrEmpty(Model.SearchKeyword))
                        {
                            <span>Không có sản phẩm nào phù hợp với từ khóa "<strong>@Model.SearchKeyword</strong>"</span>
                        }
                        else if (!string.IsNullOrEmpty(Model.CategoryId))
                        {
                            <span>Danh mục này hiện chưa có sản phẩm</span>
                        }
                        else
                        {
                            <span>Hiện chưa có sản phẩm nào trong cửa hàng</span>
                        }
                    </p>
                    <a asp-controller="Product" asp-action="Index" class="btn btn-primary">
                        <i class="fas fa-home me-2"></i>Về trang sản phẩm
                    </a>
                </div>
            }
        </div>
    </div>
</div>

<style>
    .page-header {
        border-bottom: 1px solid #e9ecef;
    }

    .filter-section {
        border-bottom: 1px solid #e9ecef;
        padding-bottom: 1rem;
    }

        .filter-section:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

    .list-group-item.active {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .btn-group .btn.active {
        background-color: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .product-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 1.5rem;
    }

    .pagination .page-item.active .page-link {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .breadcrumb-item + .breadcrumb-item::before {
        content: "›";
        color: #6c757d;
    }
</style>

@section Scripts {
    <script>
        // Update current URL for pagination links
        function updateQueryStringParameter(uri, key, value) {
            var re = new RegExp("([?&])" + key + "=.*?(&|$)", "i");
            var separator = uri.indexOf('?') !== -1 ? "&" : "?";
            if (uri.match(re)) {
                return uri.replace(re, '$1' + key + "=" + value + '$2');
            } else {
                return uri + separator + key + "=" + value;
            }
        }

        // View toggle buttons
        $('.btn-group .btn').on('click', function() {
            $('.btn-group .btn').removeClass('active');
            $(this).addClass('active');

            // Toggle between grid and list view
            if ($(this).find('.fa-list').length > 0) {
                $('.product-grid').addClass('list-view');
            } else {
                $('.product-grid').removeClass('list-view');
            }
        });

        // Price range validation
        $('input[name="minPrice"], input[name="maxPrice"]').on('change', function() {
            var minPrice = parseFloat($('input[name="minPrice"]').val()) || 0;
            var maxPrice = parseFloat($('input[name="maxPrice"]').val()) || Infinity;

            if (minPrice > maxPrice) {
                $('input[name="minPrice"]').val(maxPrice);
                $('input[name="maxPrice"]').val(minPrice);
            }
        });
    </script>
}